# 监控接口

<cite>
**本文档引用文件**  
- [monitor.go](file://backend/internal/api/monitor.go)
- [collector.go](file://backend/internal/monitor/collector.go)
- [service.go](file://backend/internal/monitor/service.go)
- [types.go](file://backend/internal/monitor/types.go)
- [ratelimit.go](file://backend/internal/middleware/ratelimit.go)
- [monitor.ts](file://frontend/src/api/monitor.ts)
- [DashboardView.vue](file://frontend/src/views/DashboardView.vue)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本文档详细说明系统监控API的设计与实现，涵盖实时指标获取、历史数据查询、数据采集机制、上报方式、指标结构、前端集成示例及限流策略。目标是为开发人员和运维团队提供完整的监控系统使用与维护指南。

## 项目结构
系统监控功能主要分布在后端 `backend/internal/monitor` 和 `backend/internal/api` 模块中，前端通过 `frontend/src/api/monitor.ts` 调用接口并在 `DashboardView.vue` 中展示数据。

```mermaid
graph TB
subgraph "前端"
Dashboard[DashboardView.vue]
MonitorAPI[monitor.ts]
end
subgraph "后端"
MonitorHandler[monitor.go]
MonitorService[service.go]
Collector[collector.go]
Types[types.go]
RateLimit[ratelimit.go]
end
Dashboard --> MonitorAPI --> MonitorHandler
MonitorHandler --> MonitorService --> Collector
MonitorHandler --> RateLimit
```

**Diagram sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L1-L50)
- [collector.go](file://backend/internal/monitor/collector.go#L1-L30)
- [DashboardView.vue](file://frontend/src/views/DashboardView.vue#L1-L20)

**Section sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L1-L50)
- [collector.go](file://backend/internal/monitor/collector.go#L1-L30)

## 核心组件
核心组件包括监控处理器（MonitorHandler）、监控服务（Service）、数据采集器（Collector）和指标类型定义（SystemMetrics）。这些组件协同工作，实现从远程服务器采集资源数据、处理请求、返回结构化监控指标的完整流程。

**Section sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L25-L100)
- [service.go](file://backend/internal/monitor/service.go#L15-L80)
- [collector.go](file://backend/internal/monitor/collector.go#L10-L50)

## 架构概览
系统采用分层架构，前端通过HTTP请求调用后端API，后端通过中间件进行限流和认证，监控处理器调用监控服务，服务层使用采集器获取本地或远程服务器资源数据。

```mermaid
sequenceDiagram
participant Frontend as 前端 (ECharts)
participant API as 监控API (monitor.go)
participant Service as 监控服务 (service.go)
participant Collector as 采集器 (collector.go)
participant System as 系统/远程服务器
Frontend->>API : GET /api/monitor?server_id=1
API->>API : ratelimit中间件检查
API->>Service : GetServerMetrics(serverID)
Service->>Collector : CollectSystemMetrics()
Collector->>System : 调用gopsutil获取指标
System-->>Collector : 返回CPU、内存等数据
Collector-->>Service : 返回SystemMetrics
Service-->>API : 返回指标数据
API-->>Frontend : JSON响应
Frontend->>API : GET /api/monitor/history?server_id=1
API->>Service : GetServerHistory(serverID, range, metric)
Service-->>API : 返回历史数据
API-->>Frontend : JSON响应
```

**Diagram sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L100-L200)
- [service.go](file://backend/internal/monitor/service.go#L30-L70)
- [collector.go](file://backend/internal/monitor/collector.go#L50-L100)

## 详细组件分析

### 监控数据采集分析
采集器通过 `gopsutil` 库获取系统级指标，支持跨平台运行。采集频率由调用方控制，默认为30秒一次。

#### 采集指标结构
```mermaid
classDiagram
class SystemMetrics {
+uint ServerID
+time.Time Timestamp
+CPUMetrics CPU
+MemoryMetrics Memory
+DiskMetrics Disk
+NetworkMetrics Network
+LoadMetrics Load
+int Processes
+int64 Uptime
}
class CPUMetrics {
+float64 Usage
+float64 UserMode
+float64 SystemMode
+float64 Idle
+float64 IOWait
+int Cores
}
class MemoryMetrics {
+uint64 Total
+uint64 Used
+uint64 Available
+float64 Usage
+uint64 SwapTotal
+uint64 SwapUsed
}
class DiskMetrics {
+[]PartitionMetrics Partitions
+DiskIOStats IOStats
}
class NetworkMetrics {
+[]NetworkInterface Interfaces
}
SystemMetrics --> CPUMetrics : 包含
SystemMetrics --> MemoryMetrics : 包含
SystemMetrics --> DiskMetrics : 包含
SystemMetrics --> NetworkMetrics : 包含
```

**Diagram sources**  
- [types.go](file://backend/internal/monitor/types.go#L10-L100)
- [collector.go](file://backend/internal/monitor/collector.go#L50-L100)

### API端点分析
监控API提供多个端点，支持实时和历史数据查询。

#### 实时指标获取流程
```mermaid
flowchart TD
Start([GET /api/monitor]) --> Validate["验证server_id参数"]
Validate --> Valid{"参数有效?"}
Valid --> |否| Return400["返回400错误"]
Valid --> |是| CallService["调用monitorService.GetServerMetrics"]
CallService --> Collect["Collector采集系统指标"]
Collect --> Format["格式化为JSON"]
Format --> Return200["返回200及指标数据"]
Return400 --> End([响应结束])
Return200 --> End
```

**Diagram sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L50-L100)
- [service.go](file://backend/internal/monitor/service.go#L20-L60)

#### 历史数据查询流程
```mermaid
flowchart TD
Start([GET /api/monitor/history]) --> ParseParams["解析server_id, time_range, metric"]
ParseParams --> Validate["验证参数"]
Validate --> Valid{"参数有效?"}
Valid --> |否| Return400["返回400错误"]
Valid --> |是| QueryDB["从数据库查询历史数据"]
QueryDB --> Aggregate["按时间聚合数据"]
Aggregate --> Format["格式化为时间序列"]
Format --> Return200["返回200及历史数据"]
Return400 --> End([响应结束])
Return200 --> End
```

**Diagram sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L200-L250)
- [service.go](file://backend/internal/monitor/service.go#L100-L150)

### 远程服务器监控机制
虽然当前 `collector.go` 主要使用 `gopsutil` 采集本地数据，但设计上支持通过SSH或Agent方式扩展远程采集。

#### SSH采集扩展逻辑
```mermaid
flowchart TD
Start([采集远程服务器数据]) --> CheckType["判断服务器类型"]
CheckType --> Local{"本地服务器?"}
CheckType --> Remote{"远程服务器?"}
Local --> UseGopsutil["使用gopsutil直接采集"]
Remote --> UseSSH["通过SSH执行远程命令"]
UseSSH --> Execute["执行'cat /proc/loadavg'等命令"]
Execute --> Parse["解析命令输出"]
Parse --> ReturnMetrics["返回指标"]
UseGopsutil --> ReturnMetrics
ReturnMetrics --> End([返回结果])
```

**Diagram sources**  
- [collector.go](file://backend/internal/monitor/collector.go#L300-L400)

### 前端集成分析
前端使用TypeScript调用监控API，并通过ECharts绘制实时图表。

#### ECharts调用示例
```mermaid
sequenceDiagram
participant Vue as DashboardView.vue
participant API as monitor.ts
participant ECharts as ECharts图表
Vue->>API : fetchServerMetrics(serverID)
API->>API : 调用axios.get(/api/monitor)
API-->>Vue : 返回JSON数据
Vue->>ECharts : setOption(配置项)
ECharts->>ECharts : 绘制CPU使用率折线图
ECharts->>ECharts : 绘制内存占用仪表盘
ECharts-->>用户 : 显示实时监控图表
loop 每30秒刷新
Vue->>API : 再次调用fetchServerMetrics
API-->>Vue : 返回新数据
Vue->>ECharts : 更新图表
end
```

**Diagram sources**  
- [monitor.ts](file://frontend/src/api/monitor.ts#L10-L50)
- [DashboardView.vue](file://frontend/src/views/DashboardView.vue#L50-L100)

**Section sources**  
- [monitor.ts](file://frontend/src/api/monitor.ts#L1-L100)
- [DashboardView.vue](file://frontend/src/views/DashboardView.vue#L1-L150)

## 依赖分析
监控系统依赖多个内部和外部组件，形成清晰的依赖链。

```mermaid
graph TD
MonitorHandler --> MonitorService
MonitorService --> Collector
MonitorService --> DatabaseManager
MonitorHandler --> RateLimit
MonitorHandler --> JWTAuth
Collector --> gopsutil
MonitorHandler --> Gin
Frontend --> MonitorAPI
MonitorAPI --> RedisCache
style MonitorHandler fill:#f9f,stroke:#333
style Collector fill:#bbf,stroke:#333
style gopsutil fill:#f96,stroke:#333
style Gin fill:#6f9,stroke:#333
```

**Diagram sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L1-L20)
- [service.go](file://backend/internal/monitor/service.go#L1-L20)
- [collector.go](file://backend/internal/monitor/collector.go#L1-L20)

**Section sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L1-L200)
- [service.go](file://backend/internal/monitor/service.go#L1-L100)
- [collector.go](file://backend/internal/monitor/collector.go#L1-L400)

## 性能考量
- **采集频率**：默认每30秒采集一次，可通过配置调整
- **数据存储**：原始数据保留24小时，每5分钟聚合一次存入长期存储
- **缓存策略**：使用Redis缓存最近一次采集结果，减少重复计算
- **并发采集**：各项指标（CPU、内存、磁盘等）通过goroutine并发采集，提高效率
- **限流措施**：基于 `middleware/ratelimit.go` 实现，限制每个IP每分钟最多100次请求

**Section sources**  
- [collector.go](file://backend/internal/monitor/collector.go#L50-L100)
- [service.go](file://backend/internal/monitor/service.go#L80-L120)
- [ratelimit.go](file://backend/internal/middleware/ratelimit.go#L1-L50)

## 故障排查指南
- **无法获取监控数据**：检查服务器是否在监控列表中，验证 `AddServerToMonitor` 是否调用成功
- **指标数据异常**：确认 `collector.go` 中的采集逻辑是否正常执行，检查gopsutil调用返回值
- **历史数据缺失**：验证数据库连接是否正常，检查数据聚合任务是否运行
- **前端图表不更新**：确认ECharts的定时刷新逻辑是否正确设置，检查API响应格式
- **频繁限流**：检查 `ratelimit.go` 配置，确认是否为正常流量或遭受攻击

**Section sources**  
- [monitor.go](file://backend/internal/api/monitor.go#L100-L250)
- [collector.go](file://backend/internal/monitor/collector.go#L100-L400)
- [ratelimit.go](file://backend/internal/middleware/ratelimit.go#L1-L50)

## 结论
本监控系统提供了完整的实时与历史数据采集、API访问、前端展示能力。通过模块化设计，易于扩展远程采集功能（SSH/Agent）。系统具备合理的性能优化和限流保护，可稳定运行于生产环境。建议后续完善远程服务器监控功能，并增加告警机制。