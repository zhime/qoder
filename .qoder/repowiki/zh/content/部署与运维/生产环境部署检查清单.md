# 生产环境部署检查清单

<cite>
**本文档引用文件**  
- [config.yaml](file://backend/configs/config.yaml)
- [config_manager.go](file://backend/internal/app/config_manager.go)
- [config.go](file://backend/internal/config/config.go)
- [ratelimit.go](file://backend/internal/middleware/ratelimit.go)
- [logger.go](file://backend/pkg/logger/logger.go)
- [monitor.go](file://backend/internal/api/monitor.go)
- [router.go](file://backend/internal/api/router.go)
- [jwt.go](file://backend/internal/auth/jwt.go)
- [nginx.conf](file://docker/nginx.conf)
- [docker-compose.yml](file://docker-compose.yml)
</cite>

## 目录
1. [引言](#引言)
2. [配置文件安全校验](#配置文件安全校验)
3. [资源限制配置](#资源限制配置)
4. [日志轮转策略](#日志轮转策略)
5. [健康检查端点](#健康检查端点)
6. [请求限流配置](#请求限流配置)
7. [HTTPS强制跳转](#https强制跳转)
8. [敏感信息环境变量管理](#敏感信息环境变量管理)
9. [性能压测建议](#性能压测建议)
10. [监控接入点](#监控接入点)
11. [总结](#总结)

## 引言
本文档旨在为qoder项目的生产环境部署提供标准化检查清单，确保系统在安全性、稳定性、可维护性和性能方面达到生产级要求。通过配置校验、资源控制、日志管理、健康检查、限流机制、HTTPS安全策略、敏感信息保护等维度，构建可靠的部署规范。

## 配置文件安全校验

### JWT密钥长度校验
JWT密钥应具备足够强度，避免暴力破解。当前配置文件中`jwt.secret`使用默认值，存在安全风险。

**检查项**：
- 确保`JWT_SECRET`环境变量存在且长度≥32字符
- 代码中通过`ConfigManager.ValidateEnvironment()`方法强制校验生产环境下的`JWT_SECRET`环境变量

[SPEC SYMBOL](file://backend/internal/app/config_manager.go#L78-L85)

### 数据库密码加密
数据库密码不应以明文形式存储。当前配置文件中`database.password`为空，实际部署时应通过环境变量注入。

**建议实践**：
- 使用环境变量`DEVOPS_DATABASE_PASSWORD`覆盖配置文件中的密码
- 配置加载通过`viper.AutomaticEnv()`支持环境变量注入

[SPEC SYMBOL](file://backend/internal/config/config.go#L87-L91)

**配置文件安全校验**
- [config.yaml](file://backend/configs/config.yaml#L25-L26)
- [config_manager.go](file://backend/internal/app/config_manager.go#L78-L85)
- [config.go](file://backend/internal/config/config.go#L87-L91)

## 资源限制配置

### CPU与内存限制
在容器化部署中，应为服务设置合理的资源限制，防止资源耗尽影响其他服务。

**Docker Compose资源配置**：
- 后端服务（backend）应添加`deploy.resources`限制
- 建议初始配置：CPU限制1核，内存512MB

```yaml
# docker-compose.yml 建议配置
backend:
  deploy:
    resources:
      limits:
        cpus: '1'
        memory: 512M
      reservations:
        cpus: '0.5'
        memory: 256M
```

[SPEC SYMBOL](file://docker-compose.yml#L30-L43)

**资源限制配置**
- [docker-compose.yml](file://docker-compose.yml#L30-L43)

## 日志轮转策略

### Zap日志文件切割
系统使用Zap日志库，结合`lumberjack`实现日志轮转。当前配置已支持按大小和时间切割。

**日志配置参数**：
- `max_size`: 单个日志文件最大100MB
- `max_backups`: 保留最多5个旧日志文件
- `max_age`: 日志文件最长保留30天
- `compress`: 启用压缩以节省磁盘空间

日志初始化由`logger.Init()`完成，确保目录自动创建。

[SPEC SYMBOL](file://backend/pkg/logger/logger.go#L40-L57)

**日志轮转策略**
- [logger.go](file://backend/pkg/logger/logger.go#L40-L57)
- [config.yaml](file://backend/configs/config.yaml#L33-L38)

## 健康检查端点

### `/health`端点配置
系统已提供`/health`健康检查端点，返回基本服务状态，可用于Kubernetes或Docker健康检查。

**端点行为**：
- 路径：`GET /health`
- 返回状态码200表示服务正常
- 返回JSON格式：`{"status": "ok", "message": "Service is running"}`

该端点无需认证，位于路由中间件之前。

[SPEC SYMBOL](file://backend/internal/api/router.go#L28-L33)

**健康检查端点**
- [router.go](file://backend/internal/api/router.go#L28-L33)

## 请求限流配置

### Ratelimit中间件启用
系统已集成基于Redis的请求限流中间件，防止API被滥用。

**限流策略**：
- 默认配置：每分钟最多100次请求
- 按用户ID或IP进行区分限流
- 登录接口单独限流：每IP每15分钟最多5次尝试

**启用方式**：
- 在路由中通过`RateLimit(rdb, config)`中间件启用
- 可针对不同API路径配置不同限流规则

[SPEC SYMBOL](file://backend/internal/middleware/ratelimit.go#L30-L115)

**请求限流配置**
- [ratelimit.go](file://backend/internal/middleware/ratelimit.go#L30-L115)
- [router.go](file://backend/internal/api/router.go#L15)

## HTTPS强制跳转

### Nginx反向代理配置
当前Nginx配置监听80端口，未启用HTTPS。生产环境应通过Nginx或Ingress实现HTTPS终止。

**建议配置**：
- 配置443端口监听并启用SSL
- 将HTTP请求301重定向至HTTPS
- 使用Let's Encrypt等证书管理工具自动更新证书

```nginx
server {
    listen 443 ssl http2;
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    # ... SSL配置
}

server {
    listen 80;
    return 301 https://$host$request_uri;
}
```

[SPEC SYMBOL](file://docker/nginx.conf#L30-L58)

**HTTPS强制跳转**
- [nginx.conf](file://docker/nginx.conf#L30-L58)

## 敏感信息环境变量管理

### 环境变量注入机制
系统通过Viper库支持环境变量覆盖配置文件，确保敏感信息不硬编码。

**环境变量前缀**：
- 所有配置项可通过`DEVOPS_`前缀的环境变量覆盖
- 示例：`DEVOPS_JWT_SECRET`, `DEVOPS_DATABASE_PASSWORD`

**生产环境校验**：
- `ConfigManager.ValidateEnvironment()`方法强制要求生产模式下必须设置`JWT_SECRET`环境变量

[SPEC SYMBOL](file://backend/internal/config/config.go#L87-L91)
[SPEC SYMBOL](file://backend/internal/app/config_manager.go#L78-L85)

**敏感信息环境变量管理**
- [config.go](file://backend/internal/config/config.go#L87-L91)
- [config_manager.go](file://backend/internal/app/config_manager.go#L78-L85)

## 性能压测建议

### 压测场景设计
为确保系统在高并发下的稳定性，建议进行以下压测：

**核心接口压测**：
- 用户登录接口（`POST /api/auth/login`）：模拟暴力破解防护
- 获取仪表盘数据（`GET /api/monitor/dashboard`）：验证缓存有效性
- 服务器监控数据获取（`GET /api/monitor/servers/:id/metrics`）：测试数据库查询性能

**压测工具建议**：
- 使用`wrk`或`k6`进行HTTP压测
- 初始目标：100并发，持续5分钟，监控错误率与响应时间

**资源监控**：
- 压测期间监控CPU、内存、Redis连接数、数据库QPS
- 观察日志是否出现限流或超时记录

**性能压测建议**
- [router.go](file://backend/internal/api/router.go#L50-L115)
- [monitor.go](file://backend/internal/api/monitor.go#L120-L257)

## 监控接入点

### 内置监控接口
系统提供多个监控接口，可用于Prometheus抓取或健康检查。

**可用监控端点**：
- `GET /api/monitor/stats`：系统统计信息
- `GET /api/monitor/dashboard`：仪表盘聚合数据
- `GET /api/monitor/servers/:id/metrics`：单台服务器实时指标
- `GET /health`：基础健康检查

**监控数据采集建议**：
- 通过Prometheus exporter定期抓取`/api/monitor/stats`
- 配置Grafana仪表盘展示服务器监控数据
- 对`/health`配置主动健康检查

[SPEC SYMBOL](file://backend/internal/api/monitor.go#L120-L257)

**监控接入点**
- [monitor.go](file://backend/internal/api/monitor.go#L120-L257)
- [router.go](file://backend/internal/api/router.go#L100-L105)

## 总结
本检查清单覆盖了qoder项目生产环境部署的关键安全与稳定性要求。建议在部署前逐项验证：
1. 配置文件敏感信息已通过环境变量注入
2. JWT密钥长度足够且未硬编码
3. 已启用请求限流保护核心接口
4. 日志轮转策略已配置并测试
5. 健康检查端点可被外部系统调用
6. Nginx已配置HTTPS强制跳转
7. 容器资源限制已设置
8. 监控系统已接入关键指标接口

通过严格执行本清单，可显著提升系统的生产环境可靠性与安全性。